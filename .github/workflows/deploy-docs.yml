name: ðŸ“š Generate & Deploy Docs

on:
  # Manual trigger from GitHub Actions tab
  workflow_dispatch:
    inputs:
      message:
        description: 'Deployment message (optional)'
        required: false
        default: 'Manual docs deployment'

  # Auto-run on push to main
  push:
    branches: [main]
    paths:
      - 'tgbotrs/src/**'
      - 'scripts/**'
      - '.github/workflows/deploy-docs.yml'

  # Weekly auto-regeneration
  schedule:
    - cron: '0 6 * * 1'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: docs-deploy
  cancel-in-progress: true

jobs:
  generate-and-deploy:
    name: ðŸ¦€ Generate Docs & Deploy
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install Python dependencies
        run: pip install beautifulsoup4 lxml 2>/dev/null || true

      - name: ðŸ”„ Regenerate docs from source
        run: |
          echo "ðŸ¦€ Starting tgbotrs documentation generator..."
          python3 scripts/generate_docs.py
          echo "âœ… Documentation generated!"

      - name: ðŸ“Š Docs stats
        run: |
          echo "=== Generated Files ==="
          ls -lah site/
          echo ""
          echo "=== File Sizes ==="
          du -sh site/*
          echo ""
          echo "Total size: $(du -sh site/ | cut -f1)"

      - name: ðŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          publish_branch: gh-pages
          force_orphan: true
          commit_message: |
            ðŸ“š Auto-deploy docs: ${{ github.event.inputs.message || github.event.head_commit.message || 'scheduled update' }}
            
            Generated from: ${{ github.sha }}
            Triggered by: ${{ github.event_name }}
            
            ðŸ¦€ tgbotrs â€” Telegram Bot API for Rust
            ðŸ‘¤ Developed by Ankit Chaubey (https://github.com/ankit-chaubey)

      - name: âœ… Deployment complete
        run: |
          echo ""
          echo "ðŸŽ‰ Docs successfully deployed!"
          echo ""
          echo "ðŸ“– Your docs are live at:"
          echo "   https://ankit-chaubey.github.io/tgbotrs/"
          echo ""
          echo "ðŸ”— Direct method links work like:"
          echo "   https://ankit-chaubey.github.io/tgbotrs/#method-send-message"
          echo "   https://ankit-chaubey.github.io/tgbotrs/#method-get-me"
          echo ""
